#!/bin/bash

uuencode=1
binary=0

function untar_payload()
{
	match=$(grep --text --line-number '^PAYLOAD:$' $0 | cut -d ':' -f 1)
	payload_start=$((match + 1))
	if [[ $binary -ne 0 ]]; then
		tail -n +$payload_start $0 | xzcat - |tar -xvf -
	fi
	if [[ $uuencode -ne 0 ]]; then
		tail -n +$payload_start $0 | uudecode | tar -xvf -
	fi
}

function __chk_cmd()
{
	CMD=$1;
	RC=`which $CMD &> /dev/null && echo 0 || echo 1`
	[ $RC -eq 0 ]
}

function __break()
{
	MSG=$1;
	echo -e $MSG;
	exit 1;
}

function check_dependencies()
{
	echo "Checking system dependencies, please wait...";
	__chk_cmd xzcat && echo -e "\tFound xzcat ..." || __break "Error: Please install xzcat or make sure it is available in \$PATH" 
	__chk_cmd jq && echo -e "\tFound jq ..." || __break "Error: Please install jq or make sure it is available in \$PATH" 
	__chk_cmd docker && echo -e "\tFound docker ..." || __break "Error: Please install docker or make sure it is available in \$PATH"
	__chk_cmd ssh && echo -e "\tFound ssh client..." || __break "Error: Please install ssh client or make sure it is available in \$PATH"
	__chk_cmd ssh-keygen && echo -e "\tFound ssh-keygen..." || __break "Error: Please install ssh-keygen or make sure it is available in \$PATH"
	__chk_cmd ssh-keyscan && echo -e "\tFound ssh-keyscan..." || __break "Error: Please install ssh-keyscan or make sure it is available in \$PATH"

	docker ps &> /dev/null && echo 'Done!' || \
		__break "Please enable docker to be managed by non-root users following this instructuion:\nhttps://docs.docker.com/install/linux/linux-postinstall/"
}

# Main
check_dependencies
read -p "Install files? " ans
if [[ "${ans:0:1}"  ||  "${ans:0:1}" ]]; then
	mkdir Container && chmod 700 Container;
	untar_payload && mv dist Container/ && cd Container/dist && ./start.sh
	# Do remainder of install steps.
fi

exit 0
